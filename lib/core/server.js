// Generated by CoffeeScript 1.6.3
var app, cli, config, connect, debug, dirs, error, fs, info, io, log, path, refresher, sourcemaps, warn, _ref;

path = require('path');

fs = require('fs');

connect = require('connect');

io = require('socket.io');

cli = require('../cli');

dirs = require('../utils/dirs');

config = require('../utils/config').parse();

sourcemaps = require('../utils/sourcemaps');

_ref = require('../utils/logger')('core/server'), error = _ref.error, warn = _ref.warn, info = _ref.info, debug = _ref.debug, log = _ref.log;

app = null;

refresher = null;

module.exports = function() {
  var address, argv, index, port, root, _ref1;
  _ref1 = config.server, root = _ref1.root, port = _ref1.port;
  argv = cli.argv();
  index = path.join(root, 'index.html');
  app = connect().use(connect["static"](root)).use(function(req, res) {
    if (~(req.url.indexOf('.'))) {
      res.statusCode = 404;
      return res.end('File not found: ' + req.url);
    } else {
      return res.end(fs.readFileSync(index, 'utf-8'));
    }
  }).listen(port);
  address = 'http://localhost:' + port;
  log("â™«  " + address);
  if (!argv.r) {
    refresher = io.listen(53211, {
      'log level': 0
    });
  }
  return module.exports;
};

module.exports.close = function() {
  return app != null ? app.close() : void 0;
};

module.exports.reload = function(type) {
  var css_output;
  if (refresher == null) {
    return;
  }
  css_output = path.basename(config.output.css);
  return refresher.sockets.emit('refresh', {
    type: type,
    css_output: css_output
  });
};

/*
//@ sourceMappingURL=server.map
*/
